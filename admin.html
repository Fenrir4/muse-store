<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUSE Admin | CRM</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --sidebar-bg: #111;
            --sidebar-text: #888;
            --sidebar-active: #fff;
            --accent: #722F37;
            --bg-body: #f0f2f5;
            --white: #fff;
            --border: #e4e6eb;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --info: #2980b9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Montserrat', sans-serif; 
            background: var(--bg-body); 
            height: 100vh; overflow: hidden; 
            color: #333; 
        }

        #admin-panel { display: flex; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar { 
            width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; 
            color: var(--sidebar-text); flex-shrink: 0; 
        }
        .brand { height: 70px; display: flex; align-items: center; padding-left: 25px; font-size: 22px; font-weight: 700; color: var(--white); letter-spacing: 2px; border-bottom: 1px solid #222; }
        .menu { flex: 1; padding-top: 20px; }
        .menu-item { display: flex; align-items: center; padding: 14px 25px; cursor: pointer; transition: 0.2s; font-size: 14px; color: var(--sidebar-text); border-left: 3px solid transparent; }
        .menu-item i { font-size: 20px; margin-right: 15px; }
        .menu-item:hover, .menu-item.active { background: #222; color: var(--sidebar-active); border-left-color: var(--accent); }
        .logout-wrapper { padding: 20px; border-top: 1px solid #222; }

        /* CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background: var(--bg-body); }
        .top-bar { height: 70px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; flex-shrink: 0; }
        .page-title { font-size: 18px; font-weight: 600; }
        .content-area { padding: 30px; overflow-y: auto; height: 100%; }

        /* TABLE */
        .data-table-container { background: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; width: 100%; }
        .table-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        .btn-main { background: var(--accent); color: #fff; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-main:hover { background: #5a222a; }
        .btn-import { background: #2c3e50; } .btn-import:hover { background: #1a252f; }
        .btn-del-all { background: #c0392b; } .btn-del-all:hover { background: #a93226; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f8f9fa; font-size: 11px; text-transform: uppercase; color: #666; font-weight: 600; border-bottom: 2px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }
        
        .row-disabled { opacity: 0.5; background: #fafafa; } 
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-right: 4px; display: inline-block; white-space: nowrap; }
        .tag-new { background: #e3f2fd; color: #2196f3; }
        .tag-hit { background: #fff3e0; color: #ff9800; }
        .tag-sale { background: #ffebee; color: #f44336; }

        /* ACTIONS & STATUS */
        .actions { display: flex; gap: 5px; }
        .act-btn { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; transition: 0.2s; }
        .btn-edit { background: #e3f2fd; color: #2196f3; }
        .btn-view { background: #e8f8f5; color: #1abc9c; } /* –ó–µ–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É */
        .btn-del { background: #ffebee; color: #f44336; }
        
        /* Select Status Style */
        .status-select {
            padding: 5px 10px; border-radius: 20px; border: none; 
            font-size: 11px; font-weight: 600; cursor: pointer; outline: none; appearance: none;
            text-align: center; width: 120px;
        }
        .st-new { background: #e3f2fd; color: #2196f3; }
        .st-process { background: #fff3e0; color: #f39c12; }
        .st-shipped { background: #f4ecf7; color: #9b59b6; }
        .st-done { background: #e8f8f5; color: #27ae60; }
        .st-canceled { background: #ffebee; color: #c0392b; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(2px); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-box { background: #fff; width: 800px; max-width: 95%; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: scale(0.95); transition: 0.3s; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); background: #f9f9f9; text-align: right; }

        /* DETAILS IN ORDER MODAL */
        .order-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .detail-group h4 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .detail-row span:first-child { color: #555; }
        .detail-row span:last-child { font-weight: 600; text-align: right; max-width: 60%; }

        .order-items-list { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .order-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; gap: 15px; }
        .order-item:last-child { border-bottom: none; }
        .order-item img { width: 50px; height: 60px; object-fit: cover; border-radius: 4px; }
        .o-info { flex: 1; }
        .o-title { font-weight: 600; font-size: 13px; }
        .o-meta { font-size: 12px; color: #888; }
        .o-price { font-weight: 600; color: var(--accent); }

        /* FORM STYLES (Product) */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: 0.2s; }
        .photo-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-remove-photo { background: #ffebee; color: #f44336; border: none; padding: 0 15px; cursor: pointer; border-radius: 6px; }
        .btn-add-photo { background: #f0f7ff; color: #007bff; border: 1px dashed #007bff; padding: 10px; width: 100%; cursor: pointer; border-radius: 6px; font-size: 13px; }
        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .custom-check { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; user-select: none; }
        .custom-check input { width: 16px; height: 16px; accent-color: var(--accent); }
        .sizes-wrapper { display: flex; gap: 10px; }
        .size-box input { display: none; }
        .size-box span { display: flex; width: 40px; height: 40px; border: 1px solid #ddd; justify-content: center; align-items: center; cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 12px; transition: 0.2s; }
        .size-box input:checked + span { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* IMPORT PROGRESS */
        #import-progress-container { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.3s; }
        #import-log { font-size: 11px; color: #666; margin-top: 5px; max-height: 100px; overflow-y: auto; font-family: monospace; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-card { width: 360px; padding: 40px; text-align: center; }
        .login-btn { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; cursor: pointer; border-radius: 6px; font-weight: 600; margin-bottom: 15px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="margin-bottom: 30px; color: var(--accent); letter-spacing: 2px;">MUSE ADMIN</h2>
            <input type="email" id="email" class="form-control" placeholder="Email" style="margin-bottom: 15px;">
            <input type="password" id="password" class="form-control" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom: 20px;">
            <button class="login-btn" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
            <label class="custom-check" style="justify-content: center;">
                <input type="checkbox" id="remember-me"> <span>–ó–∞–ø–∞–º'—è—Ç–∞—Ç–∏ –º–µ–Ω–µ</span>
            </label>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        
        <nav class="sidebar">
            <div class="brand">MUSE</div>
            <div class="menu">
                <div class="menu-item active" onclick="switchTab('products')"><i class="ph ph-t-shirt"></i> –¢–æ–≤–∞—Ä–∏</div>
                <div class="menu-item" onclick="switchTab('orders')"><i class="ph ph-shopping-cart"></i> –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
            </div>
            <div class="logout-wrapper">
                <div class="menu-item" onclick="logout()"><i class="ph ph-sign-out"></i> –í–∏–π—Ç–∏</div>
            </div>
        </nav>

        <div class="main-content">
            <div class="top-bar">
                <div class="page-title">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</div>
                <div style="font-weight: 600; font-size: 14px;">Admin</div>
            </div>

            <div class="content-area">
                
                <div id="tab-products">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>–ö–∞—Ç–∞–ª–æ–≥</h3>
                            <div style="display:flex; gap:10px;">
                                <button class="btn-main btn-del-all" onclick="deleteAllProducts()"><i class="ph ph-trash"></i> –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å–µ</button>
                                <button class="btn-main btn-import" onclick="openImportModal()"><i class="ph ph-download-simple"></i> –Ü–º–ø–æ—Ä—Ç XML</button>
                                <button class="btn-main" onclick="openModal('add')"><i class="ph ph-plus"></i> –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 60px;">–§–æ—Ç–æ</th>
                                    <th>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                                    <th>–¶—ñ–Ω–∞</th>
                                    <th>–¢–µ–≥–∏</th>
                                    <th>–î—ñ—ó</th>
                                </tr>
                            </thead>
                            <tbody id="products-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-orders" class="hidden">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
                            <div style="font-size:12px; color:#888;">–°—Ç–∞—Ç—É—Å –∑–º—ñ–Ω—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ</div>
                        </div>
                        <table>
                            <thead><tr><th>ID</th><th>–î–∞—Ç–∞</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î—ñ—ó</th></tr></thead>
                            <tbody id="orders-body">
                                <tr><td colspan="6" style="text-align:center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal-overlay" id="product-modal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modal-title">–¢–æ–≤–∞—Ä</h3>
                <i class="ph ph-x" style="font-size: 24px; cursor: pointer;" onclick="closeModal()"></i>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <div class="form-grid">
                        <div class="form-group"><label>ID (–£–Ω—ñ–∫–∞–ª—å–Ω–∏–π)</label><input type="number" id="p-id" class="form-control" required></div>
                        <div class="form-group"><label>–°—Ç–∞—Ç—É—Å</label><label class="custom-check"><input type="checkbox" id="p-instock" checked> <span>–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span></label></div>
                    </div>
                    <div class="form-group"><label>–ù–∞–∑–≤–∞</label><input type="text" id="p-title" class="form-control" required></div>
                    <div class="form-grid">
                        <div class="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                            <select id="p-category" class="form-control">
                                <option value="dress">–°—É–∫–Ω—ñ</option><option value="suit">–ö–æ—Å—Ç—é–º–∏</option>
                                <option value="top">–í–µ—Ä—Ö</option><option value="bottom">–ù–∏–∑</option>
                                <option value="outerwear">–í–µ—Ä—Ö–Ω—ñ–π –æ–¥—è–≥</option><option value="accessories">–ê–∫—Å–µ—Å—É–∞—Ä–∏</option>
                            </select>
                        </div>
                        <div class="form-group"><label>–ë—Ä–µ–Ω–¥</label><input type="text" id="p-brand" class="form-control" value="MUSE"></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>–¶—ñ–Ω–∞</label><input type="number" id="p-price" class="form-control" required></div>
                        <div class="form-group"><label>–°—Ç–∞—Ä–∞ —Ü—ñ–Ω–∞</label><input type="number" id="p-old-price" class="form-control"></div>
                    </div>
                    <div class="form-group"><label>–ú–∞—Ä–∫–µ—Ä–∏</label>
                        <div class="checkbox-group">
                            <label class="custom-check"><input type="checkbox" class="tag-check" value="new"> –ù–æ–≤–∏–Ω–∫–∞</label>
                            <label class="custom-check"><input type="checkbox" class="tag-check" value="hit"> –•—ñ—Ç</label>
                            <label class="custom-check"><input type="checkbox" class="tag-check" value="sale"> –ê–∫—Ü—ñ—è</label>
                        </div>
                    </div>
                    <div class="form-group"><label>–§–æ—Ç–æ</label><div id="photos-container"></div><button type="button" class="btn-add-photo" onclick="addPhotoField()">+ –©–µ —Ñ–æ—Ç–æ</button></div>
                    <div class="form-grid">
                        <div class="form-group"><label>–°–∫–ª–∞–¥</label><input type="text" id="p-composition" class="form-control"></div>
                        <div class="form-group"><label>–ö–æ–ª—ñ—Ä</label><input type="text" id="p-color" class="form-control"></div>
                    </div>
                    <div class="form-group"><label>–û–ø–∏—Å</label><textarea id="p-desc" class="form-control"></textarea></div>
                    <div class="form-group"><label>–†–æ–∑–º—ñ—Ä–∏</label>
                        <div class="sizes-wrapper">
                            <label class="size-box"><input type="checkbox" class="size-check" value="XS"><span>XS</span></label>
                            <label class="size-box"><input type="checkbox" class="size-check" value="S" checked><span>S</span></label>
                            <label class="size-box"><input type="checkbox" class="size-check" value="M" checked><span>M</span></label>
                            <label class="size-box"><input type="checkbox" class="size-check" value="L"><span>L</span></label>
                            <label class="size-box"><input type="checkbox" class="size-check" value="XL"><span>XL</span></label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn-main" onclick="saveProduct()">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="order-details-modal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="order-modal-title">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #...</h3>
                <i class="ph ph-x" style="font-size: 24px; cursor: pointer;" onclick="closeOrderModal()"></i>
            </div>
            <div class="modal-body" id="order-modal-content">
                </div>
            <div class="modal-footer">
                <button class="btn-main" onclick="closeOrderModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-modal">
        <div class="modal-box" style="width: 600px;">
            <div class="modal-header">
                <h3>–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è (Stefania Shop)</h3>
                <i class="ph ph-x" style="font-size: 24px; cursor: pointer;" onclick="document.getElementById('import-modal').classList.remove('active')"></i>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; color:#666; margin-bottom:15px;">
                    –í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ XML —Ñ—ñ–¥. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å —Ç–æ–≤–∞—Ä–∏, –∑–≥—Ä—É–ø—É—î —Ä–æ–∑–º—ñ—Ä–∏ —Ç–∞ –∑–±–µ—Ä–µ–∂–µ —Ñ–æ—Ç–æ.
                </p>
                <div class="form-group">
                    <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ XML Feed</label>
                    <input type="text" id="xml-url" class="form-control" 
                           value="https://stefania-shop.com.ua/products_feed.xml?hash_tag=8eb4c315f8bd025b74a6a1c07898bb67&sales_notes=&product_ids=&label_ids=108175614&exclude_fields=&html_description=1&yandex_cpa=&process_presence_sure=&languages=uk%2Cru&extra_fields=keywords&group_ids=">
                </div>
                
                <div id="import-progress-container">
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å:</span>
                        <span id="progress-text">0%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                    <div id="import-log"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-main btn-import" onclick="startImport()">üöÄ –ü–æ—á–∞—Ç–∏ —ñ–º–ø–æ—Ä—Ç</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="js/config.js"></script>

    <script>
        firebase.initializeApp(CONFIG.firebase);
        const auth = firebase.auth();
        const db = firebase.database();

        let globalProducts = [];
        let globalOrders = [];

        // AUTH
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadProducts();
                loadOrders();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        });

        function login() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            const remember = document.getElementById('remember-me').checked;
            const pers = remember ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
            auth.setPersistence(pers).then(() => auth.signInWithEmailAndPassword(e, p)).catch(err => alert("–ü–æ–º–∏–ª–∫–∞: " + err.message));
        }
        function logout() { auth.signOut(); }

        // ==========================
        // 1. ORDERS LOGIC (CRM)
        // ==========================
        function loadOrders() {
            const tbody = document.getElementById('orders-body');
            db.ref('orders').on('value', snapshot => {
                const data = snapshot.val();
                tbody.innerHTML = '';
                if(!data) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">–ó–∞–º–æ–≤–ª–µ–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î.</td></tr>'; return; }
                
                globalOrders = Object.values(data);
                // –°–æ—Ä—Ç—É—î–º–æ: –Ω–∞–π–Ω–æ–≤—ñ—à—ñ –∑–≤–µ—Ä—Ö—É
                globalOrders.sort((a,b) => b.id - a.id);

                globalOrders.forEach(o => {
                    // –ö–æ–ª—ñ—Ä —Å–µ–ª–µ–∫—Ç–∞ –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Å—Ç–∞—Ç—É—Å—É
                    let statusClass = 'st-new';
                    if(o.status === 'processing') statusClass = 'st-process';
                    else if(o.status === 'shipped') statusClass = 'st-shipped';
                    else if(o.status === 'done') statusClass = 'st-done';
                    else if(o.status === 'canceled') statusClass = 'st-canceled';

                    const html = `
                        <tr>
                            <td>#${o.id}</td>
                            <td>${o.date}</td>
                            <td>
                                <strong>${o.client.name}</strong><br>
                                <span style="font-size:11px; color:#888;">${o.client.phone}</span><br>
                                <span style="font-size:10px; color:#888;">${o.client.city}</span>
                            </td>
                            <td style="font-weight:600;">${o.total} ‚Ç¥</td>
                            <td>
                                <select class="status-select ${statusClass}" onchange="updateOrderStatus(${o.id}, this)">
                                    <option value="new" ${o.status === 'new' ? 'selected' : ''}>–ù–æ–≤–∏–π</option>
                                    <option value="processing" ${o.status === 'processing' ? 'selected' : ''}>–í —Ä–æ–±–æ—Ç—ñ</option>
                                    <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                                    <option value="done" ${o.status === 'done' ? 'selected' : ''}>–í–∏–∫–æ–Ω–∞–Ω–æ</option>
                                    <option value="canceled" ${o.status === 'canceled' ? 'selected' : ''}>–°–∫–∞—Å–æ–≤–∞–Ω–æ</option>
                                </select>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="act-btn btn-view" onclick="viewOrder(${o.id})" title="–î–µ—Ç–∞–ª—ñ"><i class="ph ph-eye"></i></button>
                                    <button class="act-btn btn-del" onclick="deleteOrder(${o.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏"><i class="ph ph-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', html);
                });
            });
        }

        function updateOrderStatus(id, select) {
            const newStatus = select.value;
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–ª—ñ—Ä —Å–µ–ª–µ–∫—Ç–∞ –≤—ñ–¥—Ä–∞–∑—É
            select.className = 'status-select';
            if(newStatus === 'new') select.classList.add('st-new');
            else if(newStatus === 'processing') select.classList.add('st-process');
            else if(newStatus === 'shipped') select.classList.add('st-shipped');
            else if(newStatus === 'done') select.classList.add('st-done');
            else if(newStatus === 'canceled') select.classList.add('st-canceled');

            db.ref('orders/' + id).update({ status: newStatus });
        }

        function deleteOrder(id) {
            if(confirm('–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?')) {
                db.ref('orders/' + id).remove();
            }
        }

        // –ú–û–î–ê–õ–ö–ê –î–ï–¢–ê–õ–ï–ô –ó–ê–ú–û–í–õ–ï–ù–ù–Ø
        function viewOrder(id) {
            const o = globalOrders.find(x => x.id === id);
            if(!o) return;

            document.getElementById('order-modal-title').textContent = `–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #${o.id}`;
            
            let itemsHtml = '';
            if(o.items && o.items.length > 0) {
                o.items.forEach(item => {
                    itemsHtml += `
                        <div class="order-item">
                            <img src="${item.image || 'https://placehold.co/50'}" alt="Img">
                            <div class="o-info">
                                <div class="o-title">${item.title}</div>
                                <div class="o-meta">–†–æ–∑–º—ñ—Ä: ${item.size}</div>
                            </div>
                            <div class="o-price">${item.price} ‚Ç¥</div>
                        </div>
                    `;
                });
            } else { itemsHtml = '<p style="padding:10px; color:#999;">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π (—Å—Ç–∞—Ä–∞ –≤–µ—Ä—Å—ñ—è)</p>'; }

            const content = `
                <div class="order-details-grid">
                    <div class="detail-group">
                        <h4>–ö–ª—ñ—î–Ω—Ç</h4>
                        <div class="detail-row"><span>–Ü–º'—è:</span> <span>${o.client.name}</span></div>
                        <div class="detail-row"><span>–¢–µ–ª–µ—Ñ–æ–Ω:</span> <span>${o.client.phone}</span></div>
                        <div class="detail-row"><span>–ú—ñ—Å—Ç–æ:</span> <span>${o.client.city}</span></div>
                        <div class="detail-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span> <span>${o.client.delivery}</span></div>
                    </div>
                    <div class="detail-group">
                        <h4>–Ü–Ω—Ñ–æ</h4>
                        <div class="detail-row"><span>–î–∞—Ç–∞:</span> <span>${o.date}</span></div>
                        <div class="detail-row"><span>–°—Ç–∞—Ç—É—Å:</span> <span>${o.status}</span></div>
                        <div class="detail-row"><span>–ö–æ–º–µ–Ω—Ç–∞—Ä:</span> <span>${o.client.comment || '-'}</span></div>
                        <div class="detail-row" style="font-size:16px; margin-top:10px;"><span>–†–∞–∑–æ–º:</span> <span style="color:#c0392b;">${o.total} ‚Ç¥</span></div>
                    </div>
                </div>
                <h4>–¢–æ–≤–∞—Ä–∏ (${o.items ? o.items.length : 0})</h4>
                <div class="order-items-list">${itemsHtml}</div>
            `;
            
            document.getElementById('order-modal-content').innerHTML = content;
            document.getElementById('order-details-modal').classList.add('active');
        }

        function closeOrderModal() { document.getElementById('order-details-modal').classList.remove('active'); }


        // ==========================
        // 2. PRODUCTS LOGIC
        // ==========================
        function loadProducts() {
            const tbody = document.getElementById('products-body');
            db.ref('products').on('value', snapshot => {
                const data = snapshot.val();
                tbody.innerHTML = '';
                if(!data) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">–ü—É—Å—Ç–æ</td></tr>'; return; }

                globalProducts = Object.values(data).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

                globalProducts.forEach(p => {
                    const img = (p.images && p.images[0]) ? p.images[0] : (p.image || '');
                    let tagsHtml = '';
                    if (p.tags) p.tags.forEach(t => tagsHtml += `<span class="tag tag-${t}">${t}</span>`);

                    const html = `
                        <tr class="${p.inStock===false ? 'row-disabled':''}">
                            <td><img src="${img}" style="width:40px; height:50px; object-fit:cover; border-radius:4px;"></td>
                            <td>
                                <strong>${p.title}</strong><br>
                                <span style="font-size:11px; color:#888;">ID: ${p.id}</span>
                                <div style="font-size:10px; color:#555;">–†–æ–∑–º—ñ—Ä–∏: ${p.sizes ? p.sizes.join(', ') : '-'}</div>
                            </td>
                            <td>${p.category || '-'}</td>
                            <td>${p.price} ‚Ç¥</td>
                            <td>${tagsHtml}</td>
                            <td>
                                <div class="actions">
                                    <button class="act-btn btn-edit" onclick="editProduct(${p.id})"><i class="ph ph-pencil-simple"></i></button>
                                    <button class="act-btn btn-del" onclick="deleteProduct(${p.id})"><i class="ph ph-trash"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    tbody.insertAdjacentHTML('beforeend', html);
                });
            });
        }

        function deleteAllProducts() {
            if(confirm("‚ö†Ô∏è –í–ò–î–ê–õ–ò–¢–ò –í–°–Ü –¢–û–í–ê–†–ò?")) {
                if(confirm("–¶–µ –æ—Å—Ç–∞—Ç–æ—á–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è. –í—Å—ñ —Ç–æ–≤–∞—Ä–∏ –∑–Ω–∏–∫–Ω—É—Ç—å.")) {
                    db.ref('products').remove().then(() => alert("–û—á–∏—â–µ–Ω–æ!"));
                }
            }
        }

        // --- –Ü–ú–ü–û–†–¢ –ó XML ---
        function openImportModal() { document.getElementById('import-modal').classList.add('active'); }

        async function startImport() {
            const url = document.getElementById('xml-url').value;
            const logEl = document.getElementById('import-log');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const container = document.getElementById('import-progress-container');
            
            if(!url) return alert("–í–≤–µ–¥—ñ—Ç—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è!");
            
            container.style.display = "block";
            logEl.innerHTML = "<div>‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è XML...</div>";
            
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                const response = await fetch(proxyUrl);
                if(!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É");
                
                const text = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");
                const offers = xmlDoc.getElementsByTagName("offer");
                const total = offers.length;
                
                logEl.innerHTML += `<div>‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: ${total}. –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤...</div>`;
                
                const groupedProducts = {}; 

                for(let i=0; i<total; i++) {
                    const offer = offers[i];
                    const name = getVal(offer, "name");
                    const groupId = offer.getAttribute("group_id") || name.trim(); 
                    let size = "S"; 
                    const params = offer.getElementsByTagName("param");
                    for(let k=0; k<params.length; k++) {
                        if(params[k].getAttribute("name") === "–†–æ–∑–º—ñ—Ä" || params[k].getAttribute("name") === "–†–∞–∑–º–µ—Ä") {
                            size = params[k].textContent;
                        }
                    }

                    if (groupedProducts[groupId]) {
                        if (!groupedProducts[groupId].sizes.includes(size)) {
                            groupedProducts[groupId].sizes.push(size);
                        }
                        continue;
                    }

                    const price = parseFloat(getVal(offer, "price"));
                    const oldPrice = parseFloat(getVal(offer, "oldprice")) || null;
                    const desc = getVal(offer, "description");
                    const vendor = getVal(offer, "vendor") || "MUSE Import";
                    const pics = [];
                    const picNodes = offer.getElementsByTagName("picture");
                    for(let j=0; j<picNodes.length; j++) pics.push(picNodes[j].textContent);

                    let category = 'other';
                    const lowerName = name.toLowerCase();
                    if(lowerName.includes('—Å—É–∫–Ω') || lowerName.includes('–ø–ª–∞—Ç—Ç') || lowerName.includes('–ø–ª–∞—Ç—å–µ')) category = 'dress';
                    else if(lowerName.includes('–∫–æ—Å—Ç—é–º') || lowerName.includes('–∫–æ–º–ø–ª–µ–∫—Ç')) category = 'suit';
                    else if(lowerName.includes('–±–ª—É–∑') || lowerName.includes('—Ç–æ–ø') || lowerName.includes('—Ñ—É—Ç–±–æ–ª–∫')) category = 'top';
                    else if(lowerName.includes('—à—Ç–∞–Ω') || lowerName.includes('–±—Ä—é–∫') || lowerName.includes('—Å–ø—ñ–¥–Ω–∏—Ü') || lowerName.includes('—é–±–∫–∞')) category = 'bottom';
                    else if(lowerName.includes('–∫—É—Ä—Ç–∫') || lowerName.includes('–ø–∞–ª—å—Ç')) category = 'outerwear';

                    groupedProducts[groupId] = {
                        id: parseInt(offer.getAttribute("id") || Date.now() + i),
                        title: name, price: price, oldPrice: oldPrice, description: desc,
                        category: category, images: pics, image: pics[0] || '',
                        sizes: [size], brand: vendor, inStock: true, tags: [], timestamp: Date.now()
                    };
                }

                const finalProducts = Object.values(groupedProducts);
                const finalCount = finalProducts.length;
                logEl.innerHTML += `<div>üì¶ –ü—ñ—Å–ª—è –æ–±'—î–¥–Ω–∞–Ω–Ω—è: ${finalCount} —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...</div>`;

                let savedCount = 0;
                for (const p of finalProducts) {
                    await db.ref('products/' + p.id).set(p);
                    savedCount++;
                    const percent = Math.round((savedCount / finalCount) * 100);
                    progressFill.style.width = percent + "%";
                    progressText.textContent = percent + "%";
                }
                
                alert(`üéâ –Ü–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ!`);
                document.getElementById('import-modal').classList.remove('active');
            } catch(e) {
                console.error(e);
                logEl.innerHTML += `<div style="color:red">‚ùå –ü–æ–º–∏–ª–∫–∞: ${e.message}</div>`;
                alert("–ü–æ–º–∏–ª–∫–∞. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
            }
        }

        function getVal(el, tag) {
            const node = el.getElementsByTagName(tag)[0];
            return node ? node.textContent : "";
        }

        // --- CRUD PRODUCTS ---
        function openModal(mode) {
            document.getElementById('product-modal').classList.add('active');
            if (mode === 'add') {
                document.getElementById('modal-title').textContent = "–ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä";
                document.getElementById('product-form').reset();
                document.getElementById('p-id').disabled = false;
                document.getElementById('photos-container').innerHTML = '';
                addPhotoField();
            }
        }
        function closeModal() { document.getElementById('product-modal').classList.remove('active'); }

        function addPhotoField(value = '') {
            const div = document.createElement('div');
            div.className = 'photo-input-group';
            div.innerHTML = `<input type="text" class="form-control photo-url" value="${value}" placeholder="URL —Ñ–æ—Ç–æ"><button type="button" class="btn-remove-photo" onclick="this.parentElement.remove()"><i class="ph ph-trash"></i></button>`;
            document.getElementById('photos-container').appendChild(div);
        }

        function saveProduct() {
            const id = document.getElementById('p-id').value;
            if(!id) return alert("ID –æ–±–æ–≤'—è–∑–∫–æ–≤–µ!");
            
            const images = [];
            document.querySelectorAll('.photo-url').forEach(i => { if(i.value) images.push(i.value); });
            const sizes = [];
            document.querySelectorAll('.size-check:checked').forEach(c => sizes.push(c.value));
            const tags = [];
            document.querySelectorAll('.tag-check:checked').forEach(c => tags.push(c.value));

            const data = {
                id: parseInt(id),
                title: document.getElementById('p-title').value,
                brand: document.getElementById('p-brand').value,
                price: parseInt(document.getElementById('p-price').value),
                oldPrice: document.getElementById('p-old-price').value ? parseInt(document.getElementById('p-old-price').value) : null,
                category: document.getElementById('p-category').value,
                composition: document.getElementById('p-composition').value,
                color: document.getElementById('p-color').value,
                description: document.getElementById('p-desc').value,
                inStock: document.getElementById('p-instock').checked,
                image: images[0] || '', images: images, sizes: sizes, tags: tags, timestamp: Date.now()
            };

            db.ref('products/' + id).update(data).then(() => closeModal());
        }

        function editProduct(id) {
            const p = globalProducts.find(x => x.id === id);
            if(!p) return;
            openModal('edit');
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-id').disabled = true;
            document.getElementById('p-title').value = p.title;
            document.getElementById('p-brand').value = p.brand;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-old-price').value = p.oldPrice || '';
            document.getElementById('p-category').value = p.category;
            document.getElementById('p-desc').value = p.description;
            
            const cont = document.getElementById('photos-container'); cont.innerHTML = '';
            (p.images || [p.image]).forEach(url => addPhotoField(url));
            
            document.querySelectorAll('.size-check').forEach(c => c.checked = false);
            if(p.sizes) p.sizes.forEach(s => {
                const cb = document.querySelector(`.size-check[value="${s}"]`);
                if(cb) cb.checked = true; 
            });
            document.querySelectorAll('.tag-check').forEach(c => c.checked = (p.tags || []).includes(c.value));
        }

        function deleteProduct(id) { if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) db.ref('products/'+id).remove(); }
        
        function switchTab(t) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('tab-products').classList.add('hidden');
            document.getElementById('tab-orders').classList.add('hidden');
            document.getElementById('tab-'+t).classList.remove('hidden');
        }
    </script>
</body>
</html>